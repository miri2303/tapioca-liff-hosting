<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>注文状況確認</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ユーザー報告により動作確認済みのSDKを使用 -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
    .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 0 auto; }
    h1 { color: #00b900; }
    .status-box { margin-top: 20px; padding: 20px; border-radius: 8px; }
    .status-waiting { background-color: #ffc107; color: #333; }
    .status-ready { background-color: #28a745; color: white; }
    .status-text { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
    .order-number { font-size: 3em; font-weight: bold; color: #333; }
    #message { margin-top: 20px; font-size: 1.1em; }
    #loading { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>タピオカドリンク注文状況</h1>
    
    <div id="loading">
      <p>LINE情報を取得中...</p>
    </div>

    <div id="content" style="display: none;">
      <p>あなたの受付番号</p>
      <div id="statusBox" class="status-box status-waiting">
        <div class="status-text">調理中</div>
        <div class="order-number" id="orderNumberDisplay">--</div>
      </div>
      <p id="message">調理完了後、LINEで通知が届きます。この画面は閉じても大丈夫です。</p>
      <p style="font-size: 0.8em; color: #999;">注文ID: <span id="orderIdDisplay"></span></p>
    </div>
  </div>

  <script>
    // テンプレートから渡された注文ID
    // LIFFアプリは外部ホスティングされるため、GASのテンプレート変数ではなくURLパラメータから取得する
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId') || "";
    // GASのWebアプリURLは、設定シートから取得する必要があるため、手動で埋め込むか、
    // LIFFアプリのデプロイ後に設定シートに書き込まれたURLをGASから取得するAPIを叩く必要があるが、
    // 今回は手動でURLを埋め込む方式を採用する。
    // **注意: ここにデプロイ後のGAS WebアプリURLを貼り付けてください**
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzQ2qrd_pfsce_JtHi62ir34CLfLwcUiAYR6-Q1BDHfXO64sygLcSODw-YBGfPOfWPr3w/exec"; 

    /**
     * LIFF初期化と処理
     */
    async function initializeLiff() {
      try {
        // 画面デバッグ用関数
        function logToScreen(message) {
          const debugArea = document.getElementById('message');
          debugArea.innerHTML = message + '<br>' + debugArea.innerHTML;
          console.log(message); // コンソールにも出力
        }

        // デバッグ: liffIdの確認
        const liffIdFromTemplate = "<?= liffId ?>";
        logToScreen('LIFF ID: ' + liffIdFromTemplate);
        
        await liff.init({ liffId: liffIdFromTemplate });
        logToScreen('LIFF Init Success'); // ここまで到達すれば初期化成功

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        if (!liff.isLoggedIn()) {
          logToScreen('Not Logged In. Redirecting to login...');
          // liff.login() にはリダイレクトURLを指定しないと、認証後に元のページに戻れない場合がある
          liff.login({ redirectUri: location.href });
          return;
        }

        logToScreen('Logged In. Getting Profile...'); // ここまで到達すればログイン成功
        // ユーザーIDを取得
        const profile = await liff.getProfile();
        const userId = profile.userId;
        logToScreen('User ID: ' + userId); // ここまで到達すればプロファイル取得成功

        // 注文IDを表示
        document.getElementById('orderIdDisplay').textContent = orderId;
        
        // 注文IDとユーザーIDをGASに送信して紐付け (Fetch APIを使用)
        if (orderId) {
          logToScreen('Linking Order ID and User ID to GAS...');
          
          const formData = new URLSearchParams();
          formData.append('action', 'linkLiffUser');
          formData.append('orderId', orderId);
          formData.append('userId', userId);

          const response = await fetch(GAS_API_URL, {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (result.status === 'success') {
            linkSuccess(result.data);
          } else {
            linkFailure(new Error(result.message));
          }

        } else {
          document.getElementById('message').textContent = '有効な注文IDがありません。';
        }

      } catch (err) {
        document.getElementById('loading').innerHTML = `<p style="color: red;">LIFF初期化エラー: ${err.message}</p>`;
        console.error('LIFF initialization failed', err);
      }
    }

    /**
     * GASへの紐付け成功時の処理
     * @param {Object} result - 紐付けられた注文情報
     */
    function linkSuccess(result) {
      logToScreen('Link Success: ' + JSON.stringify(result));
      document.getElementById('orderNumberDisplay').textContent = result.orderNumber;
      document.getElementById('message').textContent = `受付番号 ${result.orderNumber} 番とLINEアカウントを紐付けました。調理完了後、通知が届きます。`;
    }

    /**
     * GASへの紐付け失敗時の処理
     * @param {Error} error - エラーオブジェクト
     */
    function linkFailure(error) {
      logToScreen('Link Failure: ' + error.message);
      document.getElementById('message').textContent = '注文情報の紐付けに失敗しました: ' + error.message;
    }



    // ページロード時にLIFF初期化関数を実行
    window.onload = initializeLiff;
  </script>
</body>
</html>
