<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>注文状況（LIFF）</title>
  <style>
    body{font-family:system-ui,-apple-system, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Meiryo", "Noto Sans JP"; background:#f5f7fb; margin:0; padding:20px; display:flex; align-items:center; justify-content:center; min-height:100vh;}
    .card{background:#fff; padding:24px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); width:100%; max-width:420px; text-align:center;}
    h1{color:#00b900; margin:0 0 8px 0;}
    .order-number{font-size:48px; font-weight:700; margin:16px 0;}
    .status-text{font-size:18px; margin-bottom:8px;}
    #message{color:#666; font-size:14px;}
    button{padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:600;}
    .btn-primary{background:#00b900; color:#fff;}
    .btn-ghost{background:#eee; color:#333; margin-left:8px;}
    .small{font-size:12px; color:#999; margin-top:8px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>注文状況（LIFF）</h1>
    <div id="loading">LINE情報を取得中...</div>

    <div id="content" style="display:none;">
      <div class="status-text">あなたの受付番号</div>
      <div class="order-number" id="orderNumber">--</div>
      <div id="message">この画面は閉じても OK。ステータスが変わったら LINE 通知が来ます。</div>
      <div style="margin-top:16px;">
        <button class="btn-primary" id="openChat">LINE で開く</button>
        <button class="btn-ghost" id="logout">ログアウト</button>
      </div>
      <div class="small">注文ID: <span id="orderIdDisplay">-</span></div>
    </div>
  </div>

  <script>
    // ----- 必ずここを編集 -----
    const LIFF_ID = "2008278309-wnW08Lpe"; // ← LINE Developers で発行された LIFF ID を入れる
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzQ2qrd_pfsce_JtHi62ir34CLfLwcUiAYR6-Q1BDHfXO64sygLcSODw-YBGfPOfWPr3w/exec"; // ← GAS の「ウェブアプリ」URL（公開: 全員）を入れる
    // 例: "https://script.google.com/macros/s/AKfyc.../exec"
    // -------------------------

    // LIFF SDK の安定版（edge） — あなたが動作確認したものを使用
    const LIFF_SDK = "https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js";

    // --- SDK ローダー ---
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (window.liff) return resolve();
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("SDK の読み込みに失敗しました: " + src));
        document.head.appendChild(s);
      });
    }

    // --- ヘルパー: クエリパラメータ取得 ---
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function main() {
      const loadingEl = document.getElementById("loading");
      const contentEl = document.getElementById("content");
      const orderNumberEl = document.getElementById("orderNumber");
      const orderIdEl = document.getElementById("orderIdDisplay");
      const messageEl = document.getElementById("message");
      const openChatBtn = document.getElementById("openChat");
      const logoutBtn = document.getElementById("logout");

      if (!LIFF_ID || LIFF_ID.indexOf("REPLACE") !== -1) {
        loadingEl.textContent = "LIFF_ID が設定されていません。index.html を編集してください。";
        return;
      }
      if (!GAS_URL || GAS_URL.indexOf("REPLACE") !== -1) {
        loadingEl.textContent = "GAS_URL が設定されていません。index.html を編集して GAS のウェブアプリ URL を入れてください。";
        return;
      }

      try {
        await loadScript(LIFF_SDK);
      } catch (err) {
        loadingEl.textContent = "LIFF SDK の読み込みに失敗しました。ネットワークを確認してください。";
        console.error(err);
        return;
      }

      try {
        await window.liff.init({ liffId: LIFF_ID });
      } catch (err) {
        loadingEl.innerHTML = `<div style="color:red;">LIFF 初期化に失敗しました: ${err.message || err}</div>`;
        console.error("liff.init error:", err);
        return;
      }

      // ユーザがログインしてなければ login（LINE内ブラウザだと既にログイン済が多い）
      if (!window.liff.isLoggedIn()) {
        try {
          window.liff.login();
          return;
        } catch(e) {
          console.warn("login failed", e);
        }
      }

      // プロフィール取得
      let profile;
      try {
        profile = await window.liff.getProfile();
      } catch(err) {
        loadingEl.innerHTML = `<div style="color:red;">プロフィール取得に失敗しました。LINE 内ブラウザで開いているか確認してください。</div>`;
        console.error("getProfile error:", err);
        return;
      }

      // orderId は LIFF URL のクエリパラメータ ?orderId=... から受け取る想定
      const orderId = getQueryParam("orderId");
      orderIdEl.textContent = orderId || "（なし）";

      // サーバ（GAS）に紐付けリクエストを送る（application/x-www-form-urlencoded）
      if (orderId) {
        try {
          const body = `action=linkLiffUser&orderId=${encodeURIComponent(orderId)}&userId=${encodeURIComponent(profile.userId)}`;
          const resp = await fetch(GAS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
            body: body
          });
          const json = await resp.json();
          if (json.status === "success") {
            orderNumberEl.textContent = json.data.orderNumber;
            loadingEl.style.display = "none";
            contentEl.style.display = "block";
            messageEl.textContent = "注文とLINEアカウントの紐付けが完了しました。ステータスが変わったら通知が来ます。";
          } else {
            loadingEl.style.display = "none";
            contentEl.style.display = "block";
            messageEl.textContent = "紐付けに失敗しました: " + (json.message || "不明なエラー");
          }
        } catch (err) {
          loadingEl.style.display = "none";
          contentEl.style.display = "block";
          messageEl.textContent = "サーバ接続に失敗しました。GAS のデプロイ設定（匿名アクセス）を確認してください。";
          console.error(err);
        }
      } else {
        // orderId が無い場合はログイン情報のみ表示
        loadingEl.style.display = "none";
        contentEl.style.display = "block";
        messageEl.textContent = "有効な orderId がありません。QR やリンクからアクセスしてください。";
      }

      // ボタン動作
      openChatBtn.onclick = () => {
        try {
          window.open("https://line.me/R/nv/profile");
        } catch(e){ console.error(e); }
      };
      logoutBtn.onclick = () => {
        try {
          window.liff.logout();
          alert("ログアウトしました。");
        } catch(e) { console.error(e); }
      };
    }

    // 実行
    main();
  </script>
</body>
</html>
