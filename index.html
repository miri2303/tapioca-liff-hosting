<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>注文状況確認</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 動作確認済みのLIFF SDK URL -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
    .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1 ); max-width: 400px; margin: 0 auto; }
    h1 { color: #00b900; }
    .status-box { margin-top: 20px; padding: 20px; border-radius: 8px; }
    .status-waiting { background-color: #ffc107; color: #333; }
    .status-ready { background-color: #28a745; color: white; }
    .status-text { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
    .order-number { font-size: 3em; font-weight: bold; color: #333; }
    #message { margin-top: 20px; font-size: 1.1em; }
    #loading { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>タピオカドリンク注文状況</h1>
    
    <div id="loading">
      <p>LINE情報を取得中...</p>
    </div>

    <div id="content" style="display: none;">
      <p>あなたの受付番号</p>
      <div id="statusBox" class="status-box status-waiting">
        <div class="status-text">調理中</div>
        <div class="order-number" id="orderNumberDisplay">--</div>
      </div>
      <p id="message">調理完了後、LINEで通知が届きます。この画面は閉じても大丈夫です。</p>
      <p style="font-size: 0.8em; color: #999;">注文ID: <span id="orderIdDisplay"></span></p>
    </div>
  </div>

  <script>
    // =================================================================
    // 【要編集】LIFF IDとGAS API URLをここに直接貼り付けてください
    // =================================================================
    // 1. LINE Developersコンソールから取得したLIFF ID
    const LIFF_ID = "2008278309-wnW08Lpe"; 

    // 2. デプロイしたGAS WebアプリのURL
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzQ2qrd_pfsce_JtHi62ir34CLfLwcUiAYR6-Q1BDHfXO64sygLcSODw-YBGfPOfWPr3w/exec"; 
    // 例: const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzQ2qrd_pfsce_JtHi62ir34CLfLwcUiAYR6-Q1BDHfXO64sygLcSODw-YBGfPOfWPr3w/exec";
    // =================================================================

    // URLパラメータから注文IDを取得
    const urlParams = new URLSearchParams(window.location.search );
    const orderId = urlParams.get('orderId') || "";

    /**
     * 画面デバッグ用関数
     */
    function logToScreen(message) {
      const debugArea = document.getElementById('message');
      // 最新のメッセージが上に来るようにする
      debugArea.innerHTML = message + '  
' + debugArea.innerHTML;
      console.log(message);
    }

    /**
     * LIFF初期化と処理
     */
    async function initializeLiff() {
      try {
        logToScreen('LIFF ID: ' + LIFF_ID);
        
        // LIFF IDのバリデーション
        if (LIFF_ID === "ここにLIFF IDを貼り付けてください" || !LIFF_ID) {
            throw new Error("LIFF IDが設定されていません。コードを編集してください。");
        }
        
        await liff.init({ liffId: LIFF_ID });
        logToScreen('LIFF Init Success');

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        if (!liff.isLoggedIn()) {
          logToScreen('Not Logged In. Redirecting to login...');
          // リダイレクトURLと必要なスコープを明示的に指定
          liff.login({ 
            redirectUri: location.href,
            scope: 'profile openid' // ユーザーIDとプロファイル情報を確実に取得するためのスコープ
          });
          return;
        }

        logToScreen('Logged In. Getting Profile...');
        // ユーザーIDを取得
        const profile = await liff.getProfile();
        const userId = profile.userId;
        logToScreen('User ID: ' + userId);

        // 注文IDを表示
        document.getElementById('orderIdDisplay').textContent = orderId;
        
        // 注文IDとユーザーIDをGASに送信して紐付け (Fetch APIを使用)
        if (orderId) {
          logToScreen('Linking Order ID and User ID to GAS...');
          
          const formData = new URLSearchParams();
          formData.append('action', 'linkLiffUser');
          formData.append('orderId', orderId);
          formData.append('userId', userId);

          const response = await fetch(GAS_API_URL, {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (result.status === 'success') {
            linkSuccess(result.data);
          } else {
            // GASからのエラーメッセージを表示
            linkFailure(new Error(result.message));
          }

        } else {
          document.getElementById('message').textContent = '有効な注文IDがありません。';
        }

      } catch (err) {
        // エラーメッセージを画面に大きく表示
        document.getElementById('loading').innerHTML = `
          <p style="color: red; font-size: 1.5em; font-weight: bold;">LIFFエラー発生</p>
          <p style="color: red;">エラー名: ${err.name || 'UnknownError'}</p>
          <p style="color: red;">メッセージ: ${err.message}</p>
        `;
        document.getElementById('message').innerHTML = `
          <p style="color: red;">エラー詳細: ${err.message}</p>
        `;
        console.error('LIFF initialization failed', err);
      }
    }

    /**
     * GASへの紐付け成功時の処理
     */
    function linkSuccess(result) {
      logToScreen('Link Success: ' + JSON.stringify(result));
      document.getElementById('orderNumberDisplay').textContent = result.orderNumber;
      // 最終メッセージを上書き
      document.getElementById('message').innerHTML = `受付番号 ${result.orderNumber} 番とLINEアカウントを紐付けました。  
調理完了後、LINEで通知が届きます。この画面は閉じても大丈夫です。`;
    }

    /**
     * GASへの紐付け失敗時の処理
     */
    function linkFailure(error) {
      logToScreen('Link Failure: ' + error.message);
      // 最終メッセージを上書き
      document.getElementById('message').innerHTML = `<p style="color: red;">注文情報の紐付けに失敗しました: ${error.message}</p>`;
    }

    // ページロード時にLIFF初期化関数を実行
    window.onload = initializeLiff;
  </script>
</body>
</html>
